name: Deployment

on:
  push:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: demo-2-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sync code to docker apps folder
        run: |
          APP_DIR="$HOME/docker/apps/pink_fairy_armadillos"
          mkdir -p "$APP_DIR"

          # Sync repo contents into your stable deploy folder.
          # Exclude things you don't want copied over.
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "target/" \
            --exclude ".env" \
            --exclude "compose.override.yml" \
            --exclude "compose.override.backup.yml" \
            ./ "$APP_DIR/"

      - name: Build and restart containers
        run: |
          cd "$HOME/docker/apps/pink_fairy_armadillos"
          docker compose up -d --build

      - name: Show running containers
        run: |
          cd "$HOME/docker/apps/pink_fairy_armadillos"
          docker compose ps
          docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | sed -n '1p;/pfa-db/p;/pinkfairyarmadillos/p'
